rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user has specific role
    function hasRole(role) {
      return isAuthenticated() && 
             (get(/databases/$(database)/documents/customers/$(request.auth.uid)).data.role == role ||
              get(/databases/$(database)/documents/technicians/$(request.auth.uid)).data.role == role);
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return hasRole('admin');
    }
    
    // Customers collection
    match /customers/{customerId} {
      allow read: if isAuthenticated() && (request.auth.uid == customerId || isAdmin());
      allow create: if isAuthenticated() && request.auth.uid == customerId;
      allow update: if isAuthenticated() && (request.auth.uid == customerId || isAdmin());
      allow delete: if isAdmin();
    }
    
    // Technicians collection
    match /technicians/{technicianId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    // Service zips - public read, admin write
    match /service_zips/{zipId} {
      allow read: if true;
      allow write: if isAdmin();
    }
    
    // Slots - public read (for browsing available slots), admin write
    match /slots/{slotId} {
      allow read: if true;
      allow create: if isAdmin();
      allow delete: if isAdmin();
      // Allow admins to update everything, or allow authenticated users to increment/decrement booked_count
      allow update: if isAdmin() || 
        (isAuthenticated() && 
         request.resource.data.diff(resource.data).affectedKeys().hasOnly(['booked_count', 'updated_at']) &&
         (
           // Allow increment by 1 (booking)
           (request.resource.data.booked_count == resource.data.booked_count + 1 &&
            request.resource.data.booked_count <= resource.data.capacity) ||
           // Allow decrement by 1 (cancel/reschedule)
           (request.resource.data.booked_count == resource.data.booked_count - 1 &&
            request.resource.data.booked_count >= 0)
         )
        );
    }
    
    // Visits
    match /visits/{visitId} {
      allow read: if isAuthenticated() && 
                    (resource.data.customer_uid == request.auth.uid || 
                     hasRole('technician') ||
                     isAdmin());
      allow create: if isAuthenticated() && request.resource.data.customer_uid == request.auth.uid;
      allow update: if isAuthenticated() && 
                      (resource.data.customer_uid == request.auth.uid || 
                       hasRole('technician') ||
                       isAdmin());
      allow delete: if isAdmin();
    }
    
    // Messages
    match /messages/{messageId} {
      allow read: if isAuthenticated() && (resource.data.customer_uid == request.auth.uid || isAdmin());
      allow create: if isAuthenticated() && request.resource.data.customer_uid == request.auth.uid;
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Waitlist - anyone can write, admin can read
    match /waitlist/{waitlistId} {
      allow read: if isAdmin();
      allow create: if true;
      allow update, delete: if isAdmin();
    }
    
    // Pricing - public read, admin-only write
    match /pricing/{pricingId} {
      allow read: if true;
      allow write: if isAdmin();
    }
  }
}
